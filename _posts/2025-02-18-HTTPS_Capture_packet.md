---
layout: post
title: "HTTPS密文抓包"
date:   2025-02-18
tags: [cdn]
comments: true
author: xingsong
toc: true
---

在我们日常工作中，经常需要抓包分析各种异常的网络常见。
http是网络常见中最常见的一种，随着https的普及，我们生产环境中，大部分都为https的网站。而https所有的交互数据都是经过加密的。

<!-- more -->

# 概述

1. https的核心原理并不复杂，通过非对称加密传递密钥，然后拿这个密钥通过对称加密传递密文数据。
2. tls1.2原理简单点，通过客户端随机数，服务端随机数，以及预主密钥生成主密钥，然后通过主密钥加密数据。所以tls1.2版本中，我们只要知道了主密钥，就能解密数据。
3. tls1.3复杂许多，在1.2的基础上需要更多密钥，其原理可以参考: https://www.cnblogs.com/wusanga/p/17386098.html
4. 其实，无论原理如何，我们作为使用方，解密明文数据其实很简单，主要分为两个过程：
  - 记录密钥日志，抓取数据包
  - 在wireshark中导入密钥日志，打开抓取的数据包即可。
5. 记录密钥这个是大部分软件配套的功能，库都是有记录密钥功能的

# 获取密钥

## Linux 客户端

> curl 通过设置 SSLKEYLOGFILE 环境变量记录密钥日志的。比如：
> - 添加环境变量：`[root ~]# export SSLKEYLOGFILE=/tmp/ssl.log`
> - 访问：`[root ~]# curl https://www.baidu.com` 
> 此时使用 tls1.2 版本请求：`[root ~]# curl --tlsv1.2 https://www.baidu.com`
> 查看ssl.log文件，发现密钥日志文件只有一行密钥内容。第一列是标签，tls1.2中就是客户端随机数。第二列就是客户端随机数。一次会话中客户端的随机数是固定的。所以，一般会用第二列标识会话。第二列相同就是同一个会话。第三列就是密钥了。在tls1.2中就是主密钥。
> ~~~ shell
> $ cat /tmp/ssl.log 
> # SSL/TLS secrets log file, generated by NSS
> CLIENT_RANDOM 1b152f16c50cae5bcae6845dc1190e2b66d2ce5dfdcbcc3c59371911290aab08 dbc10f1d8ba7ee7b0cc6abc80ce51c2707cd547fa59e04810b2eabd455c59953430b53a06318e3ea9f946cfd4bbf0355
> ~~~
